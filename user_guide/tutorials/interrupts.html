
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Task Interrupts &#8212; UPSTAGE 1.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/tutorials/interrupts';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Task Rehearsal" href="rehearsal.html" />
    <link rel="prev" title="First UPSTAGE Simulation" href="first_simulation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/upstage-logo-medium.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../_static/upstage-logo-medium.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">UPSTAGE</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    UPSTAGE API
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/JamesArruda/upstage/" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    UPSTAGE API
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/JamesArruda/upstage/" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="first_simulation.html">First UPSTAGE Simulation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Task Interrupts</a></li>
<li class="toctree-l1"><a class="reference internal" href="rehearsal.html">Task Rehearsal</a></li>
<li class="toctree-l1"><a class="reference internal" href="best_practices.html">Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="simpy_compare.html">UPSTAGE vs SimPy</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Full Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="first_sim_full.html">First Simulation Full Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="rehearsal_sim.html">Rehearsal Simulation Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="complex_cashier.html">Complex Cashier Full Source</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">How-Tos</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../how_tos/active_states.html">Active States</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/mimic_states.html">Mimic States</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/nucleus.html">Task Nucleus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/stage_variables.html">Stage Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/geography.html">Geography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/decision_tasks.html">Decision Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/task_networks.html">Task Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/state_sharing.html">State Sharing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/entity_naming.html">Named Entities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/motion_manager.html">Motion Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/communications.html">Communications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_tos/random_numbers.html">Random Numbers</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Task Interrupts</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="task-interrupts">
<h1>Task Interrupts<a class="headerlink" href="#task-interrupts" title="Link to this heading">#</a></h1>
<p>Task interruption handling is one of UPSTAGE’s convenience features for wrapping SimPy. It allows you to use interruptions to modify the task network without having to write
exceptions over all the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statements.</p>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<p>For reference, here is how you might handle interruptions in a process with two timeouts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">simpy</span> <span class="k">as</span> <span class="nn">SIM</span>

<span class="k">def</span> <span class="nf">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> :: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_and_work</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Environment</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Store</span><span class="p">):</span>
    <span class="n">get_event</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">get_event</span>
        <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;got the item: &#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Interrupt</span> <span class="k">as</span> <span class="n">interrupt</span><span class="p">:</span>
        <span class="c1"># No matter what, cancel the get and leave</span>
        <span class="n">get_event</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Interrupted in the get wait. Cause: </span><span class="si">{</span><span class="n">interrupt</span><span class="o">.</span><span class="n">cause</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">time_to_work</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="c1"># This could be a function of your item</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">time_to_work</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">time_to_work</span><span class="p">)</span>
            <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;Finished work&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Interrupt</span> <span class="k">as</span> <span class="n">interrupt</span><span class="p">:</span>
            <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Interrupted in the work wait with cause: </span><span class="si">{</span><span class="n">interrupt</span><span class="o">.</span><span class="n">cause</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">interrupt</span><span class="o">.</span><span class="n">cause</span> <span class="o">==</span> <span class="s2">&quot;CANCEL GET&quot;</span><span class="p">:</span>
                <span class="c1"># do nothing, the cancel is too late</span>
                <span class="c1"># but get ready to loop again!</span>
                <span class="n">time_to_work</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">env</span><span class="o">.</span><span class="n">now</span>
            <span class="k">elif</span> <span class="n">interrupt</span><span class="o">.</span><span class="n">cause</span> <span class="o">==</span> <span class="s2">&quot;CANCEL WORK&quot;</span><span class="p">:</span>
                <span class="k">return</span>

<span class="k">def</span> <span class="nf">putter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;THING&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The work in that process is very simple, but the cancelling and code required to handle interrupts that we may not care about complicates it greatly. In general, we prefer a task/process
to explain exactly what it’s trying to do, and we can handle interrupts separately without clouding the business logic of the task.</p>
<p>In addition, if interrupts are sent by another process, we don’t want the other process to have to know about introspecting the actor or the task network to know if it can/should do the
interrut. It’s preferable to let the interrupting process ask for an interrupt (with some data) and let the actor/task decide if it’s a good idea or not. Finally, if the simulation builder
does not remember to always cancel events (especially get and put), then you may end up with a get request that takes from a store without going anywhere.</p>
<p>Here’s how those interrupts would look in SimPy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Interrupt in the get wait</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="n">proc1</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">putter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>
<span class="n">proc2</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">get_and_work</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>

<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">proc2</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">cause</span><span class="o">=</span><span class="s2">&quot;outer stop&quot;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;DONE&quot;</span><span class="p">)</span>
<span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Items in store: </span><span class="si">{</span><span class="n">store</span><span class="o">.</span><span class="n">items</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">0.50</span> <span class="p">::</span> <span class="n">Interrupted</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">get</span> <span class="n">wait</span><span class="o">.</span> <span class="n">Cause</span><span class="p">:</span> <span class="n">outer</span> <span class="n">stop</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.00</span> <span class="p">::</span> <span class="n">DONE</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.00</span> <span class="p">::</span> <span class="n">Items</span> <span class="ow">in</span> <span class="n">store</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;THING&#39;</span><span class="p">]</span>

<span class="c1"># Interrupt in the work wait with an ignorable cause</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="n">proc1</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">putter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>
<span class="n">proc2</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">get_and_work</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>

<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">proc2</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">cause</span><span class="o">=</span><span class="s2">&quot;CANCEL GET&quot;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;DONE&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.00</span> <span class="p">::</span> <span class="n">got</span> <span class="n">the</span> <span class="n">item</span><span class="p">:</span> <span class="s1">&#39;THING&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.50</span> <span class="p">::</span> <span class="n">Interrupted</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">work</span> <span class="n">wait</span> <span class="k">with</span> <span class="n">cause</span><span class="p">:</span> <span class="n">CANCEL</span> <span class="n">GET</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">3.00</span> <span class="p">::</span> <span class="n">Finished</span> <span class="n">work</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">3.00</span> <span class="p">::</span> <span class="n">DONE</span>

<span class="c1"># Interrupt in the work wait with a real cause</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

<span class="n">proc1</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">putter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>
<span class="n">proc2</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">get_and_work</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>

<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">proc2</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">cause</span><span class="o">=</span><span class="s2">&quot;CANCEL WORK&quot;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;DONE&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.00</span> <span class="p">::</span> <span class="n">got</span> <span class="n">the</span> <span class="n">item</span><span class="p">:</span> <span class="s1">&#39;THING&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.50</span> <span class="p">::</span> <span class="n">Interrupted</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">work</span> <span class="n">wait</span> <span class="k">with</span> <span class="n">cause</span><span class="p">:</span> <span class="n">CANCEL</span> <span class="n">WORK</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">3.00</span> <span class="p">::</span> <span class="n">DONE</span>
</pre></div>
</div>
<p>If you interrupt without an approved cause, and miss a final <code class="docutils literal notranslate"><span class="pre">else</span></code> (like in this example), you’d finish the work at time 3.5.</p>
<p>Very critically, if you missed putting the <code class="docutils literal notranslate"><span class="pre">get_event.cancel()</span></code> line, SimPy would still process the <code class="docutils literal notranslate"><span class="pre">get_event</span></code> and take the item from the store. This would effectively remove it from the simulation.</p>
</section>
<section id="upstage-interrupts">
<h2>UPSTAGE Interrupts<a class="headerlink" href="#upstage-interrupts" title="Link to this heading">#</a></h2>
<p>UPSTAGE’s interrupt handling system mitigates these key sources of error or frustration:</p>
<ol class="arabic simple">
<li><p>Forgetting to cancel get and put events in an interrupt</p></li>
<li><p>Make the main task more readable about what it’s doing.</p></li>
<li><p>Simplifies interrupt causes and conditions.</p></li>
<li><p>Forgetting to stop some calculation of a state</p></li>
</ol>
<p>To access these features, do the following:</p>
<ol class="arabic simple">
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">on_interrupt</span></code> in the <a class="reference internal" href="../../upstage.html#upstage.task.Task" title="upstage.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code></a> class.</p></li>
<li><p>Optionally: use the <code class="docutils literal notranslate"><span class="pre">marker</span></code> features in the task and interrupt methods.</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../upstage.html#upstage.task.Task.set_marker" title="upstage.task.Task.set_marker"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_marker()</span></code></a></p></li>
<li><p><a class="reference internal" href="../../upstage.html#upstage.task.Task.get_marker" title="upstage.task.Task.get_marker"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_marker()</span></code></a></p></li>
<li><p><a class="reference internal" href="../../upstage.html#upstage.task.Task.clear_marker" title="upstage.task.Task.clear_marker"><code class="xref py py-meth docutils literal notranslate"><span class="pre">clear_marker()</span></code></a></p></li>
</ul>
</li>
</ol>
<p>We’ll start simple, then add complexity to the interrupt.</p>
<p>Here’s what the above process would look like as an UPSTAGE Task:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">import</span> <span class="nn">upstage.api</span> <span class="k">as</span> <span class="nn">UP</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">simpy</span> <span class="k">as</span> <span class="nn">SIM</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">def</span> <span class="nf">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 6</span>    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> :: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos"> 7</span>    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">def</span> <span class="nf">putter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">):</span>
<span class="linenos">11</span>    <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="linenos">12</span>    <span class="k">yield</span> <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;THING&quot;</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="k">class</span> <span class="nc">DoWork</span><span class="p">(</span><span class="n">UP</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="linenos">16</span>    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="n">UP</span><span class="o">.</span><span class="n">Actor</span><span class="p">):</span>
<span class="linenos">17</span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s2">&quot;getting&quot;</span><span class="p">)</span>
<span class="linenos">18</span>        <span class="n">item</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">UP</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
<span class="linenos">19</span>        <span class="n">env_print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;got the item: &#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s2">&quot;working&quot;</span><span class="p">)</span>
<span class="linenos">22</span>        <span class="k">yield</span> <span class="n">UP</span><span class="o">.</span><span class="n">Wait</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="linenos">23</span>        <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;Finished work&quot;</span><span class="p">)</span>
<span class="linenos">24</span>
<span class="linenos">25</span>    <span class="k">def</span> <span class="nf">on_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="n">UP</span><span class="o">.</span><span class="n">Actor</span><span class="p">,</span> <span class="n">cause</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="linenos">26</span>        <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_marker</span><span class="p">()</span>
<span class="linenos">27</span>        <span class="n">env_print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;INTERRUPT:</span><span class="se">\n\t</span><span class="s2">Got cause: &#39;</span><span class="si">{</span><span class="n">cause</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n\t</span><span class="s2">During marker: &#39;</span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="linenos">28</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="o">.</span><span class="n">END</span>
</pre></div>
</div>
<p>Then, when you run it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">UP</span><span class="o">.</span><span class="n">EnvironmentContext</span><span class="p">()</span> <span class="k">as</span> <span class="n">env</span><span class="p">:</span>
    <span class="n">actor</span> <span class="o">=</span> <span class="n">UP</span><span class="o">.</span><span class="n">Actor</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">UP</span><span class="o">.</span><span class="n">add_stage_variable</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>

    <span class="n">task</span> <span class="o">=</span> <span class="n">DoWork</span><span class="p">()</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">actor</span><span class="o">=</span><span class="n">actor</span><span class="p">)</span>

    <span class="n">proc1</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">putter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>

    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">cause</span><span class="o">=</span><span class="s2">&quot;because&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Items in store: </span><span class="si">{</span><span class="n">store</span><span class="o">.</span><span class="n">items</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="mf">0.50</span> <span class="p">::</span> <span class="n">INTERRUPT</span><span class="p">:</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">Got</span> <span class="n">cause</span><span class="p">:</span> <span class="s1">&#39;because&#39;</span>
    <span class="o">&gt;&gt;&gt;</span> <span class="n">During</span> <span class="n">marker</span><span class="p">:</span> <span class="s1">&#39;getting&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.00</span> <span class="p">::</span> <span class="n">Items</span> <span class="ow">in</span> <span class="n">store</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;THING&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now the task is small and informative about what it’s supposed to do when its not interrupted. The marker features let us set and get introspection data cleanly.</p>
<p>Notice also that the <code class="docutils literal notranslate"><span class="pre">Get()</span></code> call does not need to be cancelled by the user; UPSTAGE does that for us (for all <a class="reference internal" href="../../upstage.html#upstage.events.BaseEvent" title="upstage.events.BaseEvent"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseEvent</span></code></a> subclasses that implement <code class="docutils literal notranslate"><span class="pre">cancel</span></code>).</p>
<p>Some additional details:</p>
<ul class="simple">
<li><p>Line 25: The <code class="docutils literal notranslate"><span class="pre">on_interrupt</span></code> method will pass in the actor and the interrupt cause only.</p></li>
<li><p>Line 21: If we didn’t do: <code class="docutils literal notranslate"><span class="pre">self.set_marker(&quot;working&quot;)</span></code> here, the Task would still think it was marked as <code class="docutils literal notranslate"><span class="pre">&quot;getting&quot;</span></code>. Yields do not clear marks.</p>
<ul>
<li><p>You can use <code class="docutils literal notranslate"><span class="pre">clear_marker</span></code> to clear it, and return to a default behavior if you like.</p></li>
</ul>
</li>
<li><p>Line 26: If no marker is set, the <code class="docutils literal notranslate"><span class="pre">get_marker</span></code> method will return <code class="docutils literal notranslate"><span class="pre">None</span></code></p></li>
<li><p>Line 28: More on <code class="docutils literal notranslate"><span class="pre">INTERRUPT</span></code> below.</p></li>
</ul>
<section id="interrupt-types-and-setting-markers">
<h3>INTERRUPT Types and Setting Markers<a class="headerlink" href="#interrupt-types-and-setting-markers" title="Link to this heading">#</a></h3>
<p>Interrupts allow 4 different outcomes to the task, which are signalled by the <a class="reference internal" href="../../upstage.html#upstage.task.InterruptStates" title="upstage.task.InterruptStates"><code class="xref py py-class docutils literal notranslate"><span class="pre">InterruptStates</span></code></a> Enum (or <a class="reference internal" href="../../upstage.html#upstage.task.Task.INTERRUPT" title="upstage.task.Task.INTERRUPT"><code class="xref py py-class docutils literal notranslate"><span class="pre">INTERRUPT</span></code></a> as part of <code class="docutils literal notranslate"><span class="pre">self</span></code>). The first
three can be returned from <code class="docutils literal notranslate"><span class="pre">on_interrupt</span></code> to define how to handle the interrupt.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">END</span></code>: Ends the task right there (and moves on in the task network). This cancels the pending event(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IGNORE</span></code>: When returned, keeps the task moving along as if the interrupt didn’t happen</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RESTART</span></code>: Starts the task back over. This cancels the pending event(s).</p></li>
</ol>
<p>UPSTAGE Tasks work by being the process that SimPy sees and managing the internal <code class="docutils literal notranslate"><span class="pre">task()</span></code> loop as its own generator, passing SimPy events to the event handler as needed. By default, it assumes
you want to <code class="docutils literal notranslate"><span class="pre">END</span></code> the task on an interrupt. This is assumed when no <code class="docutils literal notranslate"><span class="pre">on_interrupt</span></code> is defined.</p>
<p>Markers allow some flexibility in handling interrupts. If you do not define an <code class="docutils literal notranslate"><span class="pre">on_interrupt</span></code>, then you can use <code class="docutils literal notranslate"><span class="pre">self.set_marker(marker,</span> <span class="pre">self.INTERRUPT.IGNORE)</span></code> to ignore interrupts while that marker is active.</p>
<p>If you implement <code class="docutils literal notranslate"><span class="pre">on_interrupt</span></code>, then the marker’s interrupt value is ignored.</p>
</section>
</section>
<section id="advanced-interrupts-and-marking">
<h2>Advanced Interrupts and Marking<a class="headerlink" href="#advanced-interrupts-and-marking" title="Link to this heading">#</a></h2>
<p>Let’s return to our example, and add more complicated interrupt handling, including with an active state on the actor.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">UP</span><span class="o">.</span><span class="n">Actor</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">time_worked</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">UP</span><span class="o">.</span><span class="n">LinearChangingState</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">DoWork</span><span class="p">(</span><span class="n">UP</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="linenos"> 5</span>    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="n">Worker</span><span class="p">):</span>
<span class="linenos"> 6</span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s2">&quot;getting&quot;</span><span class="p">)</span>
<span class="linenos"> 7</span>        <span class="n">actor</span><span class="o">.</span><span class="n">activate_linear_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;time_worked&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos"> 8</span>        <span class="n">item</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">UP</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
<span class="linenos"> 9</span>        <span class="n">env_print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;got the item: &#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="s2">&quot;working&quot;</span><span class="p">)</span>
<span class="linenos">12</span>        <span class="k">yield</span> <span class="n">UP</span><span class="o">.</span><span class="n">Wait</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="linenos">13</span>        <span class="n">actor</span><span class="o">.</span><span class="n">deactivate_all_states</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
<span class="linenos">14</span>        <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">&quot;Finished work&quot;</span><span class="p">)</span>
<span class="linenos">15</span>
<span class="linenos">16</span>    <span class="k">def</span> <span class="nf">on_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="n">Worker</span><span class="p">,</span> <span class="n">cause</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="linenos">17</span>        <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_marker</span><span class="p">()</span>
<span class="linenos">18</span>        <span class="n">marker_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_marker_time</span><span class="p">()</span>
<span class="linenos">19</span>        <span class="n">env_print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;INTERRUPT:</span><span class="se">\n\t</span><span class="s2">Got cause: &#39;</span><span class="si">{</span><span class="n">cause</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n\t</span><span class="s2">During marker: &#39;</span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">Which started at: </span><span class="si">{</span><span class="n">marker_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span>        <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="s2">&quot;getting&quot;</span><span class="p">:</span>
<span class="linenos">22</span>            <span class="k">if</span> <span class="n">cause</span> <span class="o">==</span> <span class="s2">&quot;CANCEL GET&quot;</span><span class="p">:</span>
<span class="linenos">23</span>                <span class="n">time_passed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">marker_time</span>
<span class="linenos">24</span>                <span class="c1"># Allow some leeway that we won&#39;t cancel the wait if it&#39;s been long enough</span>
<span class="linenos">25</span>                <span class="k">if</span> <span class="n">time_passed</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
<span class="linenos">26</span>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="o">.</span><span class="n">IGNORE</span>
<span class="linenos">27</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">28</span>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="o">.</span><span class="n">END</span>
<span class="linenos">29</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">30</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="o">.</span><span class="n">IGNORE</span>
<span class="linenos">31</span>        <span class="k">elif</span> <span class="n">marker</span> <span class="o">==</span> <span class="s2">&quot;working&quot;</span><span class="p">:</span>
<span class="linenos">32</span>            <span class="k">if</span> <span class="n">cause</span> <span class="o">==</span> <span class="s2">&quot;CANCEL WORK&quot;</span><span class="p">:</span>
<span class="linenos">33</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="o">.</span><span class="n">END</span>
<span class="linenos">34</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">35</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">INTERRUPT</span><span class="o">.</span><span class="n">IGNORE</span>
<span class="linenos">36</span>        <span class="c1"># A return of None will cause an error, which might be what we want to know.</span>
</pre></div>
</div>
<p>The new features are:</p>
<ul class="simple">
<li><p>Line 13: Get the time we set the marker</p></li>
<li><p>Line 18: Use the marker time to determine how we want to interrupt</p></li>
<li><p>Line 31: Remind ourselves that returning <code class="docutils literal notranslate"><span class="pre">None</span></code> throws an exception</p></li>
</ul>
<p>With these features we now have separated the logic of a successful task from one that is interrupted. It also allows more structure and streamlining of interrupt actions.</p>
<p>Here’s an example where the automatic cancelling of an active state is also shown:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">UP</span><span class="o">.</span><span class="n">EnvironmentContext</span><span class="p">()</span> <span class="k">as</span> <span class="n">env</span><span class="p">:</span>
    <span class="n">actor</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">SIM</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">UP</span><span class="o">.</span><span class="n">add_stage_variable</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>

    <span class="n">task</span> <span class="o">=</span> <span class="n">DoWork</span><span class="p">()</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">actor</span><span class="o">=</span><span class="n">actor</span><span class="p">)</span>

    <span class="n">proc1</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">putter</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">store</span><span class="p">))</span>

    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mf">1.75</span><span class="p">)</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">cause</span><span class="o">=</span><span class="s2">&quot;CANCEL WORK&quot;</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">env_print</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Time worked: </span><span class="si">{</span><span class="n">actor</span><span class="o">.</span><span class="n">time_worked</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.00</span> <span class="p">::</span> <span class="n">got</span> <span class="n">the</span> <span class="n">item</span><span class="p">:</span> <span class="s1">&#39;THING&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">1.75</span> <span class="p">::</span> <span class="n">INTERRUPT</span><span class="p">:</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">Got</span> <span class="n">cause</span><span class="p">:</span> <span class="s1">&#39;CANCEL WORK&#39;</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">During</span> <span class="n">marker</span><span class="p">:</span> <span class="s1">&#39;working&#39;</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">Which</span> <span class="n">started</span> <span class="n">at</span><span class="p">:</span> <span class="mf">1.0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">3.00</span> <span class="p">::</span> <span class="n">Items</span> <span class="ow">in</span> <span class="n">store</span><span class="p">:</span> <span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">3.00</span> <span class="p">::</span> <span class="n">Time</span> <span class="n">worked</span><span class="p">:</span> <span class="mf">1.75</span>
</pre></div>
</div>
<p>The interrupt automatically deactivates all states, keeping your Actors safe from runaway state values.</p>
</section>
<section id="getting-the-process">
<h2>Getting the Process<a class="headerlink" href="#getting-the-process" title="Link to this heading">#</a></h2>
<p>If an actor is running a task network, you will need to get the current Task process to send an interrupt. Do that with the <a class="reference internal" href="../../upstage.html#upstage.actor.Actor.get_running_tasks" title="upstage.actor.Actor.get_running_tasks"><code class="xref py py-meth docutils literal notranslate"><span class="pre">upstage.actor.Actor.get_running_tasks()</span></code></a> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">network_processes</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">get_running_tasks</span><span class="p">()</span>
<span class="n">task_name</span><span class="p">,</span> <span class="n">task_process</span> <span class="o">=</span> <span class="n">network_processes</span><span class="p">[</span><span class="n">task_network_name</span><span class="p">]</span>
<span class="n">task_process</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">cause</span><span class="o">=</span><span class="s2">&quot;Stop running&quot;</span><span class="p">)</span>

<span class="c1"># OR:</span>
<span class="n">task_name</span><span class="p">,</span> <span class="n">task_process</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">get_running_task</span><span class="p">(</span><span class="n">task_network_name</span><span class="p">)</span>
<span class="n">task_process</span><span class="o">.</span><span class="n">interrupt</span><span class="p">(</span><span class="n">cause</span><span class="o">=</span><span class="s2">&quot;Stop running&quot;</span><span class="p">)</span>

<span class="c1"># OR:</span>
<span class="n">actor</span><span class="o">.</span><span class="n">interrupt_network</span><span class="p">(</span><span class="n">task_network_name</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="s2">&quot;Stop running&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The first two methods are better to use if you need to check that the task name is the right one for interrupt. A well-defined task network should handle the interrupt anywhere, though.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="first_simulation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">First UPSTAGE Simulation</p>
      </div>
    </a>
    <a class="right-next"
       href="rehearsal.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Task Rehearsal</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upstage-interrupts">UPSTAGE Interrupts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interrupt-types-and-setting-markers">INTERRUPT Types and Setting Markers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-interrupts-and-marking">Advanced Interrupts and Marking</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-process">Getting the Process</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/user_guide/tutorials/interrupts.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, UPSTAGE Contributors, GTRI.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.4.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>